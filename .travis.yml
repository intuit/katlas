sudo: true
go_import_path: github.com/intuit/katlas

dist: xenial
language: go
network:
  host: 0.0.0.0
http:
  port: 8011


go:
  - 1.11.x

services:
  - docker
  
install:
  - cd $TRAVIS_BUILD_DIR/service && make all
  #- cd $TRAVIS_BUILD_DIR/app && yarn install

before_script:
  - docker pull dgraph/dgraph
  - mkdir -p /tmp/data
  - docker run -d -it -p 5080:5080 -p 6080:6080 -p 8080:8080 -p 9080:9080 -p 8000:8000 -v /tmp/data:/dgraph --name diggy dgraph/dgraph dgraph zero
  - docker exec -d -it diggy dgraph alpha --lru_mb 2048 --zero localhost:5080

script:
  - cd $TRAVIS_BUILD_DIR/service
  - go test -v ./... -coverprofile=coverage.txt -covermode=atomic
  #- docker build --no-cache -f Dockerfile -t katlas-service:${TRAVIS_COMMIT} .
  #- cd $TRAVIS_BUILD_DIR/app
  #- yarn test --coverage
  #- docker build --no-cache -f Dockerfile -t katlas-browser:${TRAVIS_COMMIT} .
  #- cd $TRAVIS_BUILD_DIR/service
  - lsof -i :8011
  - go run server.go &> output.out
  - cat ./output.out
  - lsof -i :8011
  - cat /etc/hosts
  - "curl -o queryResult.json -X GET -H 'Content-Type: application/json' \"http://127.0.0.1:8011/v1/query?name=pod\""
  - if [ $? -ne 0 ]; then
        echo "Integration Test - Success! Need to push image to docker hub!";
    else
    	  echo "Integration Test - Fail!";
    fi

after_success:
  #- cd $TRAVIS_BUILD_DIR/service
  #- bash <(curl -s https://codecov.io/bash)
  #- cd $TRAVIS_BUILD_DIR/app
  #- bash <(curl -s https://codecov.io/bash) -f coverage/coverage-final.json
